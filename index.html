<html>
<head>
    <title>Electrip</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="head">
        <h1>Electrip</h1>
    </div>

    <h2 style="text-align: center;">Find the best route for your electric car</h2>
    

    <div class="center">
        <div id="map"></div>
        <div class="input">
            <div id="info">
                <form id="infoForm">
                    <label for="start">Start:
                        <input type="text" id="start" name="start" placeholder="Start address">
                    </label>
            
                    <label for="end">End:
                        <input type="text" id="end" name="end" placeholder="End address">
                    </label>
            
                    <label for="battery">Battery:
                        <input type="number" id="battery" name="battery" placeholder="Battery level">
                    </label>
            
                    <input type="submit" value="Submit" onclick="doSummary()">
                </form>
            </div>
            <div class="buttons">
                <button onclick="getVehicles()" class="center-button">Display the available vehicles</button>
                <button onclick="resetPage()">Choose another trip</button>
            </div>
            
            <div id="vehiclesList">
            </div>
        </div>
    </div>

    
    
        <p>Summary of your trip :</p>
        <p id="depart">Origin : </p>
        <p id="arrive">End : </p>
        <p id="charge">Battery : 0 %</p>

        <button onclick="getCoords()">Get the coordinates</button>
        <p id="coordsD"> </p>
        <br/>
        <p id="coordsA"> </p>
        <br/>



    <button onclick="drawRoad()">Draw the road</button>
    <button onclick="getBornes()">Get the bornes</button>
    
    
    <br/>

    <div id="chargingStations"></div>

    <br/>

    


    <div id="time">
        <h1 id="trip">The trip time is estimated to 0 mins.</h1>
        <!-- <button onclick="getTripTime()">Get the trip time</button> -->
        <br/>
        <br/>
        <form>
            <label for="distance">Distance:</label>
            <input type="text" id="distance" name="distance" placeholder="Distance">
    
            <label for="vitesse">Speed:</label>
            <input type="text" id="vitesse" name="vitesse" placeholder="Speed">
    
            <label for="points">Points:</label>
            <input type="text" id="points" name="points" placeholder="Points">
    
            <input type="submit" value="Submit" onclick="getRealTime()">
        </form>
        <br/>
        
    </div>

    
    

    <script>
        function reverseCoords(tab){
            var newTab = [];
            for (var i = 0; i < tab.length; i++){
                newTab.push([tab[i][1], tab[i][0]]);
            }
            return newTab;
        }

        var map = L.map('map').setView([45.584386, 5.909277], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var latlngs= [];

        var dist = 0;
        var timeETA = 0;
        var spd = 0;

        var selectedChargeTripRange = null;

        var chargingStations = [];

        function drawRoad(){
            const url = '/route/'+latD+'/'+longD+'/'+latA+'/'+longA+'/';

            fetch(url)
            .then(response => response.text())
            .then(data => {
                jsonData = JSON.parse(data);
                latlngs = jsonData.features[0].geometry.coordinates;
                latlngs = reverseCoords(latlngs);
                dist = jsonData.features[0].properties.summary.distance / 1000;
                timeETA = jsonData.features[0].properties.summary.duration / 3600;
                spd = dist / timeETA;
                document.getElementById("vitesse").value = spd;
                document.getElementById("distance").value = dist;
                var polyline = L.polyline(latlngs, {color : 'red'}).addTo(map);
                L.marker(latlngs[0]).addTo(map).bindPopup('Start');
                L.marker(latlngs[latlngs.length-1]).addTo(map).bindPopup('End');
                map.fitBounds(polyline.getBounds());
            })
            .catch(error => {
                console.log(error);
            });

        }

        

        function getVehicles(){
            fetch('/vehicles')
            .then(response => response.text())
            .then(data => {
                // document.getElementById("vehicles").innerHTML = data;
                jsonData = JSON.parse(data);
                var vehiclesContainer = document.getElementById("vehiclesList");
                jsonData.vehicleList.forEach(function(vehicle){
                    var vehicleDiv = document.createElement("div");
                    vehicleDiv.classList.add("vehicleCard");
                    vehicleDiv.innerHTML = `
                        <img src="${vehicle.media.image.url}" alt="${vehicle.naming.make} ${vehicle.naming.model}">
                        <div>
                            <h2>${vehicle.naming.make} ${vehicle.naming.model} ${vehicle.naming.version || ''}</h2>
                            <p>Seats: ${vehicle.body.seats}</p>
                            <p>Usable Battery: ${vehicle.battery.usable_kwh} kWh</p>
                            <p>Chargetrip Range: ${vehicle.range.chargetrip_range.best} - ${vehicle.range.chargetrip_range.worst} miles</p>
                            <p>Fast Charging Support: ${vehicle.routing.fast_charging_support ? 'Yes' : 'No'}</p>
                        </div>
                    `;
                    vehicleDiv.addEventListener('click', function(){
                        selectedChargeTripRange = (vehicle.range.chargetrip_range.best + vehicle.range.chargetrip_range.worst) / 2; 
                        console.log(selectedChargeTripRange);
                        resetSelection();
                        vehicleDiv.style.backgroundColor = "#82b08f";
                    });
                    vehiclesContainer.appendChild(vehicleDiv);
                })
            })
            .catch(error => {
                console.log(error);
            });
        }

        function getDistance(lat1, lon1, lat2, lon2){
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = 0.5 - Math.cos(dlat) / 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function findChargingStations(road, autonomy, chargingStations) {
            const result = [];
            for (let i = 0; i < road.length - 1; i++) {
                const startPoint = road[i];
                const endPoint = road[i + 1];
                const segmentDistance = getDistance(startPoint[0], startPoint[1], endPoint[0], endPoint[1]);
                for (const station of chargingStations) {
                    const distanceToStart = getDistance(startPoint[0], startPoint[1], station.geo_point_borne.lat, station.geo_point_borne.lon);
                    const distanceToEnd = getDistance(endPoint[0], endPoint[1], station.geo_point_borne.lat, station.geo_point_borne.lon);
                    if (distanceToStart <= autonomy || distanceToEnd <= autonomy) {
                        result.push(station);
                    } else {
                        const projectedPoint = projectPointOnSegment([station.geo_point_borne.lat, station.geo_point_borne.lon], startPoint, endPoint);
                        const projectedDistance = getDistance(projectedPoint[0], projectedPoint[1], station.geo_point_borne.lat, station.geo_point_borne.lon);
                        if (projectedDistance <= autonomy) {
                            result.push(station);
                        }
                    }
                }
            }
            return result;
        }

        function getBornes(){
            fetch('/bornesData')
            .then(response => response.text())
            .then(data =>{
                console.log(data);

                return fetch("/findChargingStations");
            })
            .then(response => response.text())
            .then(data => {
                jsonData = JSON.parse(data);
                chargingStations = findChargingStations(latlngs, selectedChargeTripRange, jsonData);
                console.log(chargingStations);
            })
            .catch(error => {
                console.error("Error fetching charging stations: ", error);
            });
            
        }

        function displayBornes(bornes){
            var bornesDiv = document.getElementById("chargingStations");
            bornesDiv.innerHTML = "";

            if(bornes.length === 0){
                bornesDiv.innerHTML = "<p>No charging stations found</p>";
            }else{
                const ul = document.createElement("ul");
                bornes.forEach(station => {
                    const li = document.createElement("li");
                    li.textContent = `${station.n_station} - ${station.ad_station}`;
                    ul.appendChild(li);
                });
                bornesDiv.appendChild(ul);
            }
        }

        function resetPage(){
            document.getElementById("trip").innerHTML = "The trip time is estimated to 0 mins.";
            document.getElementById("vehiclesList").innerHTML = "";
            document.getElementById("chargingStations").innerHTML = "";
            document.getElementById("start").innerHTML = "";
            document.getElementById("end").innerHTML = "";
            document.getElementById("battery").innerHTML = "";
            document.getElementById("depart").innerHTML = "Origin : ";
            document.getElementById("arrive").innerHTML = "End : ";
            document.getElementById("charge").innerHTML = "Battery : 0 %";
            latlngs = [];
            dist = 0;
            timeETA = 0;
            spd = 0;
            selectedChargeTripRange = null;
        }

        function resetSelection(){
            var vehicleItems = document.querySelectorAll(".vehicleCard");
            vehicleItems.forEach(function(vehicleItem){
                vehicleItem.style.backgroundColor = "";
            });
        }

        function getTripTime(){
            fetch('/tripTime')
            .then(response => response.text())
            .then(data => {
                document.getElementById("trip").innerHTML = "The trip time is estimated to " + data + " mins.";
            })
            .catch(error => {
                console.log(error);
            });
        }

        function doSummary(){
            event.preventDefault();
            document.getElementById("depart").innerHTML = "Origin : " + document.getElementById("start").value;
            document.getElementById("arrive").innerHTML = "End : " + document.getElementById("end").value;
            document.getElementById("charge").innerHTML = "Battery : " + document.getElementById("battery").value.toString() + " %";
        }

        function getRealTime(){
            event.preventDefault();
            const distance = document.getElementById("distance").value.toString();
            const vitesse = document.getElementById("vitesse").value.toString();
            const points = document.getElementById("points").value.toString();

            const url = '/tripTime/'+distance+'/'+vitesse+'/'+points+'/';

            fetch(url)
            .then(response => response.text())
            .then(data => {
                document.getElementById("trip").innerHTML = "The trip time is estimated to " + data + " mins.";
            })
            .catch(error => {
                console.log(error);
            });
        }

        var latD = 0;
        var longD = 0;
        var latA = 0;
        var longA = 0;

        function getCoords(){
            const pos = document.getElementById("start").value.toString();

            const url = '/coordinates/'+pos+'/';

            fetch(url)
            .then(response => response.text())
            .then(data => {
                jsonData = JSON.parse(data);
                const coordinates = jsonData.features[0].geometry.coordinates;
                const latitude = coordinates[1];
                const longitude = coordinates[0];

                document.getElementById("coordsD").innerHTML = "Latitude : " + latitude.toString() + " Longitude : " + longitude.toString();

                latD = latitude;
                longD = longitude;
            })
            .catch(error => {
                console.log(error);
            });

            const arr = document.getElementById("end").value.toString();

            const url2 = '/coordinates/'+arr+'/';

            fetch(url2)
            .then(response => response.text())
            .then(data => {
                console.log(data);
                jsonData = JSON.parse(data);
                const coordinates = jsonData.features[0].geometry.coordinates;
                const latitude = coordinates[1];
                const longitude = coordinates[0];

                document.getElementById("coordsA").innerHTML = "Latitude : " + latitude.toString() + " Longitude : " + longitude.toString();

                latA = latitude;
                longA = longitude;
            })
            .catch(error => {
                console.log(error);
            });
        }
    </script>
</body>